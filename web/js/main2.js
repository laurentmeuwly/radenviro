var mapDatagrid={handler:null,datagrid:null,natures:null,inputs:null,nuclides:null,cacheForNuclides:{},lastCallKey:null,preventRefreshingFromNuclides:!1,initialize:function(){var e=this;return this.handler=$("#handler_5_last_result"),this.datagrid=$("#datagrid_5_last_result"),this.natures=$("#nature_5_last_result"),this.inputs=$('.section.samples li input[type="checkbox"]').not(".selectall"),this.nuclides=$("#nuclides_5_last_result"),this.inputs.change(function(){e.refresh()}),this.nuclides.change(function(){e.preventRefreshingFromNuclides||e.refreshDatagrid($(this).val())}),this},refresh:function(e){if(this.inputs.length>0){var t=this.inputs.filter(":checked"),n=[],r=[];t.length===0&&e&&(t=$(this.inputs.get(0))),t.length>0?(this.show(),t.each(function(){var e=$(this);n.push(e.data("legend")),r.push(e.data("nature"))}),this.datagrid.data("legends",n),this.refreshNuclides(),this.refreshDatagrid("first"),this.natures.html(r.join(",&nbsp;"))):(this.datagrid.data("legends",null),this.hide())}return this},refreshDatagrid:function(e){var t=this.datagrid.data("legends")||[];if(this.isVisible()&&t.length>0&&e){this.lastCallKey=t.join(",");var n={url:this.datagrid.data("url")+"&legends[]="+t.join("&legends[]=")+"&nuclide="+e};this.datagrid.flexOptions(n),this.datagrid.flexReload()}return this},refreshNuclides:function(){var e=this,t=this.datagrid.data("legends")||[];if(this.isRefreshable()&&this.isVisible()&&t.length>0){var n="?legends[]="+t.join("&legends[]="),r=this.cacheForNuclides[n]||!1,i=function(t){e.preventRefreshingFromInputs=!0,e.nuclides.empty();var n="";$.each(t,function(e,t){n+='<option value="'+t.value+'">'+t.label+"</option>"}),e.nuclides.append(n),nuclides_change(e.nuclides),e.preventRefreshingFromInputs=!1};r?i(r):$.getJSON(this.nuclides.attr("data-refresh")+n,function(t){e.cacheForNuclides[n]=t,i(t)})}return this},show:function(){this.handler.show().css("visibility","visible")},hide:function(){this.handler.hide().css("visibility","hidden")},isRefreshable:function(){if(this.lastCallKey!==null){var e=this.datagrid.data("legends")||[];if(e.join(",")===this.lastCallKey)return!1}return!0},isVisible:function(){return this.handler.is(":visible")}},mapHandler={params:{height:0,width:0,latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},handler:null,image:null,zoom:null,closeBtn:null,callbackOnZoomOut:null,initialize:function(){var e=this;this.handler=$("div.map div.content"),this.image=$("#switzerland"),this.zoom=$("#switzerland_zoom").css("display","none"),this.closeBtn=$("#zoom_closebtn").css("display","none"),this.closeBtn.click(function(){e.zoomOut()}),this.image.load(function(){e._buildParams(),mapDatagrid.initialize(),mapSamples.initialize(e.params),mapSites.initialize(e.params),mapNetworks.initialize(e.params),mapSamples.selectFromCookie()||mapSamples.selectFirst()}).attr("src",this.image.data("src"))},zoomIn:function(e,t,n){if(e&&e.length>0){var r=this;this.zoom.load(function(){r.zoom.css({display:"none",height:r.image.height(),position:"absolute",width:r.image.width(),"z-index":2e3}).fadeIn(),t&&setTimeout(function(){t.apply()},10),r.closeBtn.fadeIn()})}this.zoom.attr("src",e),this.callbackOnZoomOut=n},zoomOut:function(e){this.zoom.off("load"),this.zoom.fadeOut("fast"),this.closeBtn.hide(),e&&setTimeout(function(){e.apply()},10),this.handler.find(".sublocation").hide(),this.callbackOnZoomOut&&this.callbackOnZoomOut.apply(),this.callbackOnZoomOut=null},_buildParams:function(){var e=this.image.height(),t=this.image.width(),n=e/(this.params.latitudeTop-this.params.latitudeDown),r=t/(this.params.longitudeDown-this.params.longitudeTop);this.params=$.extend(this.params,{height:e,width:t,latitudeRatio:n,longitudeRatio:r,latitudeZoom:n/this.params.zoom,longitudeZoom:r/this.params.zoom})}},mapPointsIndex=0,mapPoints=function(e,t,n){var r=this,i=$(e);this.index=mapPointsIndex+1,mapPointsIndex++,this.params=$.extend({latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},t||{}),this.options=$.extend({locationClassName:"location",click:function(){var e=$(this),t=e.data("link")||!1,n=e.data("link-target")||!1;if(t)switch(n){case"_blank":window.open(t);break;default:window.location=t}},hide:function(){},locationPositionning:function(e,t,n){return{left:n.params.padding+(e[1]-n.params.longitudeTop)*n.params.longitudeRatio-t.width()/2,top:n.params.padding+(n.params.latitudeTop-e[0])*n.params.latitudeRatio-t.height()/2}},additionalPositionningParams:[]},n||{}),this.map=$("div.map div.content"),this.locations=i.find("span."+this.options.locationClassName),this.locationsBuilded=!1,this.locationsBuilding=!1,setTimeout(function(){!this.locationsBuilding&&!r.locationsBuilded&&r._buildLocations()},700+this.index*200)};mapPoints.prototype._buildLocations=function(){var e=this;!this.locationsBuilding&&!this.locationsBuilded&&(this.locationsBuilding=!0,this.locations.hide().each(function(){var t=$(this),n=$("#"+t.data("icon")),r=t.data("latitude"),i=t.data("longitude"),s=[r,i];t.data("positions",s),t.css($.extend({cursor:"pointer"},e.options.locationPositionning.apply(t,$.merge([s,n,e],e.options.additionalPositionningParams)))).append(n.clone()).appendTo(e.map),t.qtip({content:{text:t.find("span.text").html()||"&nbsp;",title:{text:t.find("span.title").html()}},hide:{delay:400,fixed:!0,when:{event:"mouseout"}}}),e.options.click&&t.click(e.options.click)}),this.locationsBuilding=!1,this.locationsBuilded=!0)},mapPoints.prototype.show=function(){!this.locationsBuilding&&!this.locationsBuilded&&this._buildLocations(),this.locations.fadeIn()},mapPoints.prototype.hide=function(){this.locations.hide();if(this.options.hide){var e=this;this.locations.each(function(){var t=$(this);setTimeout(function(){e.options.hide.apply(t)},10)})}},mapPoints.prototype.getLocation=function(e){return this.locations.filter("#"+e)};var mapZoomArea=function(e,t){var n=$(e),r=this;this.params=$.extend({latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},t||{}),this.bounds=$.extend({},{east:n.data("elongitude"),north:n.data("nlatitude"),south:n.data("slatitude"),west:n.data("wlongitude"),latitudeRatio:this.params.height/(n.data("nlatitude")-n.data("slatitude")),longitudeRatio:this.params.width/(n.data("elongitude")-n.data("wlongitude"))}),this.staticmap="http://www.radenviro.ch/staticmap/api/staticmap?center="+n.data("latitude")+","+n.data("longitude")+"&zoom="+n.data("zoom")+"&size=430x290&maptype=roadmap&sensor=false",this.map=$("div.map div.content"),this.locations=[],this.zoomed=!1;var i=this.params.padding+(this.params.latitudeTop-this.bounds.south)*this.params.latitudeRatio,s=this.params.padding+(this.bounds.west-this.params.longitudeTop)*this.params.longitudeRatio,o=this.params.padding+(this.bounds.east-this.params.longitudeTop)*this.params.longitudeRatio,u=this.params.padding+(this.params.latitudeTop-this.bounds.north)*this.params.latitudeRatio;n.css({left:s,height:i-u,top:u,width:o-s}).click(function(){r.zoomIn()}),this.map.append(n)};mapZoomArea.prototype.restoreLocationPosition=function(e){var t=$(e),n=t.data("original-left"),r=t.data("original-top");t.css({left:n,top:r,"z-index":1050})},mapZoomArea.prototype.setLocationPosition=function(e){var t=this,n=$(e),r=n.data("zoom-left"),i=n.data("zoom-top");if(!r&&!i){var s=n.data("latitude"),o=n.data("longitude"),u=$("#"+n.data("icon"));r=t.params.padding+(o-t.bounds.west)*t.bounds.longitudeRatio-u.width()/2,i=t.params.padding+(t.bounds.north-s)*t.bounds.latitudeRatio-u.height()/2,n.data("zoom-left",r),n.data("zoom-top",i)}n.css({left:r,top:i,"z-index":2050})},mapZoomArea.prototype.zoomIn=function(){var e=this;this.zoomOut(),mapHandler.zoomIn(this.staticmap,function(){e.locations.length===0?e.map.find(".location.samples").each(function(){var t=$(this),n=t.data("latitude"),r=t.data("longitude");n>=e.bounds.south&&n<=e.bounds.north&&r>=e.bounds.west&&r<=e.bounds.east&&(e.locations.push(this),t.data("original-left",t.css("left")),t.data("original-top",t.css("top")),e.setLocationPosition(this))}):$.each(e.locations,function(){e.setLocationPosition(this)}),e.map.find(".zoomarea").hide()},function(){$.each(e.locations,function(){e.restoreLocationPosition(this)}),e.map.find(".zoomarea").show()}),this.zoomed=!0},mapZoomArea.prototype.zoomOut=function(){if(this.zoomed){var e=this;$.each(this.locations,function(){e.restoreLocationPosition(this)}),e.map.find(".zoomarea").show(),mapHandler.zoomOut()}this.zoomed=!1};var mapSamples={params:{cookieName:"map-filters",latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},inputs:null,selectalls:null,legends:null,points:[],zooms:null,zoomareas:[],initialized:!1,initialize:function(e){if(!this.initialized){this.initialized=!0;var t=this;this.inputs=$('.section.samples li input[type="checkbox"]').not(".selectall"),this.selectalls=$('.section.samples li input[type="checkbox"].selectall'),this.legends=$(".section.samples li"),this.zooms=$(".section.samples .zooms div"),this.params=$.extend(this.params,e||{}),this.inputs.change(function(){t.selectalls.prop("checked",t.inputs.filter(":checked").length==t.inputs.length)}),this.selectalls.change(function(){t.inputs.prop("checked",$(this).prop("checked")).change()}),this._buildLegends(),this._buildZooms()}return this},reset:function(){this.hideAllPoints(),this.inputs.prop("checked",!1),this.selectalls.prop("checked",!1),this.zoomOut(),this.hideAllZooms()},hideAllPoints:function(){$.each(this.points,function(){this.hide()})},hideAllZooms:function(){this.zooms.hide()},showAllZooms:function(){this.zooms.show()},selectFirst:function(){this.inputs.first().prop("checked",!0).change()},selectFromCookie:function(){var e=this.getInputsInCookie();if(e){var t=this.inputs.filter(e.join(","));if(t.length>0)return t.prop("checked",!0).change(),!0}return!1},zoomOut:function(){$.each(this.zoomareas,function(){this.zoomOut()})},getInputsInCookie:function(){var e=$.cookie(this.params.cookieName),t=[];return e&&e.substr(0,8)==="samples:"&&(t=e.substr(8).split(",")),t.filter(function(e){return e})},_updateCookie:function(e,t){var n=this.getInputsInCookie(),r=n.indexOf(e);t&&r==-1&&n.push(e),!t&&r>=0&&delete n[r],$.cookie(this.params.cookieName,"samples:"+n.join(","))},_buildZooms:function(){var e=this;this.zooms.each(function(){var t=new mapZoomArea(this,e.params);e.zoomareas.push(t)})},_buildLegends:function(){var e=this;this.legends.each(function(t){var n=new mapPoints(this,e.params,{index:t}),r=$(this).find('input[type="checkbox"]').first();e.points.push(n),r.change(function(){$(this).is(":checked")?(e.showAllZooms(),mapSites.reset(),mapNetworks.reset(),n.show(),e._updateCookie("#"+r.attr("id"),!0)):(n.hide(),e._updateCookie("#"+r.attr("id"),!1))})})}},mapSites={params:{cookieName:"map-filters",latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},inputs:null,selects:null,categories:null,points:[],zoomed:!1,initialized:!1,initialize:function(e){return this.initialized||(this.initialized=!0,this.inputs=$('.section.sites li input[type="radio"]'),this.selects=$(".section.sites select"),this.categories=$(".section.sites li"),this.params=$.extend(this.params,e||{}),this._buildCategories()),this},selectFromCookie:function(){var e=this.getInputInCookie();if(e){var t=this.inputs.filter(e);if(t.length>0)return elements.prop("checked",!0).change(),!0}return!1},getInputInCookie:function(){var e=$.cookie(this.params.cookieName);return e&&e.substr(0,6)==="sites:"?e.substr(6):""},_updateCookie:function(e){$.cookie(this.params.cookieName,"sites:"+e)},reset:function(){this.hideAllPoints(),this.selects.hide(),this.inputs.first().prop("checked",!0),this.zoomed&&mapHandler.zoomOut()},hideAllPoints:function(){$.each(this.points,function(){this.hide()})},_buildCategories:function(){var e=this;this.categories.each(function(){var t=$(this).find('input[type="radio"]').first(),n=e.selects.filter("#"+t.attr("id")+"_sites"),r=new mapPoints(this,e.params,{click:function(){var t=$(this),r={east:t.data("elongitude"),north:t.data("nlatitude"),south:t.data("slatitude"),west:t.data("wlongitude"),latitudeRatio:e.params.height/(t.data("nlatitude")-t.data("slatitude")),longitudeRatio:e.params.width/(t.data("elongitude")-t.data("wlongitude"))},i="http://www.radenviro.ch/staticmap/api/staticmap?center="+t.data("latitude")+","+t.data("longitude")+"&zoom="+t.data("zoom")+"&size=430x290&maptype=roadmap&sensor=false";mapHandler.zoomOut(),mapHandler.zoomIn(i,function(){var i=t.data("sublocations");i||(i=new mapPoints(t,e.params,{locationClassName:"sublocation",locationPositionning:function(e,t,n,i){return{left:n.params.padding+(e[1]-r.west)*r.longitudeRatio-t.width()/2,top:n.params.padding+(r.north-e[0])*r.latitudeRatio-t.height()/2}},additionalPositionningParams:[t.data("positions")]}),t.data("sublocations",i)),i.show(),n.val(t.data("id"))},function(){n.find("option").first().prop("selected",!0),e.zoomed=!1}),e.zoomed=!0},hide:function(){var e=this.data("sublocations");e&&e.hide()}});n.change(function(){var e=r.getLocation("location_site_"+$(this).val());e.length>0&&e.click()}),e.points.push(r),t.change(function(){$(this).is(":checked")&&(mapHandler.zoomOut(),mapDatagrid.hide(),mapSamples.reset(),mapNetworks.reset(),e.hideAllPoints(),r.show(),e.selects.hide(),n.show(),e._updateCookie("#"+t.attr("id")))})})}},mapNetworks={params:{latitudeTop:47.808455,longitudeTop:5.956082,latitudeDown:45.81792,longitudeDown:10.48914,zoom:4e5,padding:15,latitudeRatio:0,longitudeRatio:0,latitudeZoom:0,longitudeZoom:0},inputs:null,categories:null,points:[],initialized:!1,initialize:function(e){return this.initialized||(this.initialized=!0,this.inputs=$('.section.automatic_network_stations li input[type="radio"]'),this.categories=$(".section.automatic_network_stations li"),this.params=$.extend(this.params,e||{}),this._buildCategories()),this},reset:function(){this.hideAllPoints(),this.inputs.first().prop("checked",!0)},hideAllPoints:function(){$.each(this.points,function(){this.hide()})},_buildCategories:function(){var e=this;this.categories.each(function(){var t=$(this).find('input[type="radio"]').first(),n=new mapPoints(this,e.params);e.points.push(n),t.change(function(){$(this).is(":checked")&&(mapDatagrid.hide(),mapSamples.reset(),mapSites.reset(),e.hideAllPoints(),n.show())})})}},advancedSearchHandler=function(){var e=this;this.networks=$(".advsearch_environments select"),this.stations=$(".advsearch_stations select"),this.stationsHandler=$(".advsearch_stations"),this.nuclides=$(".advsearch_nuclides option"),this.nuclidesSelect=$(".advsearch_nuclides select"),this.nuclidesHandler=$(".advsearch_nuclides"),this.submits=$(".advsearch_submits input"),this.submitsHandler=$(".advsearch_submits"),this.nuclides.each(function(){var e=$(this),t=e.data("stations")||"0";try{e.data("estations",t.split(","))}catch(n){e.data("estations",[])}});var t="",n=e.nuclidesHandler.data("url")+"/",r=function(){return e.stationsHandler.hide(),e.stations.hide().find("option").prop("selected",!1).attr("selected",!1),e},i=function(){return e.nuclidesHandler.hide(),e.nuclides.hide().prop("selected",!1).attr("selected",!1),e},s=function(t){return t.length>0?(e.stationsHandler.show(),e.stations.filter("."+t).show(),e.stations.not("."+t).hide().find("option").prop("selected",!1).attr("selected",!1),e.nuclides.hide().prop("selected",!1).attr("selected",!1)):(r(),i()),e},o=function(t){return t.length>0?(e.nuclidesHandler.show(),e.nuclides.filter(function(){return $(this).data("estations").indexOf(t)>=0}).show(),e.nuclides.filter(function(){return $(this).data("estations").indexOf(t)<0}).hide().find("option").prop("selected",!1).attr("selected",!1)):i(),e},u=function(){e.submitsHandler.hide(),t=""};this.submits.click(function(){t.length>0&&(window.location=t+"#"+$(this).data("anchor"))}),this.nuclidesSelect.change(function(){t.length>0&&e.submitsHandler.show()}),this.stations.change(function(){u();var e=$(this).find("option:selected"),r=e.data("url")||"";if(r.length>0)window.location=$(this).find("option:selected").data("url");else{var i=e.val()||"";i.length>0&&(o(i),t=n+i)}}),this.networks.change(function(){s($(this).find("option:selected").data("stations")||""),u()});var a=this.networks.find("option:selected"),f=a.data("stations")||"";if(f.length>0){var l=this.stations.filter("."+f);s(a.data("stations")||"");if(l.length>0){var c=l.find("option:selected").val()||"";c.length>0&&(o(c),t=n+c)}}};

(function($){
    $(document.body).ready(function(){
        // Initialize map
        mapHandler.initialize();
        
        // Initialize advanced search
        new advancedSearchHandler();
    });
})(jQuery);